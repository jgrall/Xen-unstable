
# This is the correct place to edit the build version.
# All other places this is stored (eg. compile.h) should be autogenerated.
export XEN_VERSION       = 2
export XEN_SUBVERSION    = 0
export XEN_EXTRAVERSION  = ""

export BASEDIR          := $(shell pwd)

include Rules.mk

default: $(TARGET)
	gzip -f -9 < $(TARGET) > $(TARGET).gz

debug:	
	objdump -D -S $(TARGET)-syms > $(TARGET).s

install: $(TARGET)
	gzip -f -9 < $(TARGET) > $(TARGET).gz
	mkdir -p $(prefix)/boot
	install -m0644 $(TARGET).gz $(prefix)/boot
	install -m0644 $(TARGET)-syms $(prefix)/boot
	mkdir -p $(prefix)/usr/include/xen/io
	install -m0644 include/public/*.h $(prefix)/usr/include/xen
	install -m0644 include/public/io/*.h $(prefix)/usr/include/xen/io
	install -m0644 include/public/COPYING $(prefix)/usr/include/xen

dist: $(TARGET)
	$(MAKE) prefix=`pwd`/../dist/install dist=yes install

clean:
	$(MAKE) -C figlet clean
	$(MAKE) -C common clean
	$(MAKE) -C drivers clean
	$(MAKE) -C arch/$(TARGET_ARCH) clean
	rm -f include/asm *.o $(TARGET)* *~ core include/xen/compile.h
	rm -f include/asm-*/asm-offsets.h

$(TARGET): delete-unfresh-files
	[ -e include/asm ] || ln -sf asm-$(TARGET_ARCH) include/asm
	$(MAKE) include/xen/compile.h
	$(MAKE) -C arch/$(TARGET_ARCH) asm-offsets.s
	$(MAKE) include/asm-$(TARGET_ARCH)/asm-offsets.h
	$(MAKE) -C common
	$(MAKE) -C drivers
	$(MAKE) -C arch/$(TARGET_ARCH)

# Blow away kernel.o because build info is stored statically within it.
delete-unfresh-files:
	rm -f include/xen/compile.h common/kernel.o

# compile.h contains dynamic build info. Rebuilt on every 'make' invocation.
include/xen/compile.h:
	@LANG=C echo /\* Autogenerated by root Makefile. Do not edit. \*/ > $@
	@LANG=C echo >> $@
	@LANG=C echo \#define XEN_COMPILE_DATE \"`date`\" >> $@
	@LANG=C echo \#define XEN_COMPILE_TIME \"`date +%T`\" >> $@
	@LANG=C echo \#define XEN_COMPILE_BY \"`whoami`\" >> $@
	@LANG=C echo \#define XEN_COMPILE_DOMAIN \"`([ -x /bin/dnsdomainname ] && /bin/dnsdomainname) || ([ -x /bin/domainname ] && /bin/domainname || echo [unknown])`\" >> $@
	@LANG=C echo \#define XEN_COMPILE_HOST \"`hostname`\" >> $@
	@LANG=C echo \#define XEN_COMPILER \"`$(CC) $(CFLAGS) -v 2>&1 | tail -1`\" >> $@
	@LANG=C echo >> $@
	@LANG=C echo \#define XEN_VERSION\ \ \ \ \ \ $(XEN_VERSION) >> $@
	@LANG=C echo \#define XEN_SUBVERSION\ \ \ $(XEN_SUBVERSION) >> $@
	@LANG=C echo \#define XEN_EXTRAVERSION \"$(XEN_EXTRAVERSION)\" >> $@
	@LANG=C echo >> $@
	@LANG=C echo \#define XEN_CHANGESET \"`bk changes -nd':D: :T: :REV: :MD5KEY:' -r+ 2>/dev/null || echo "information unavailable"`\" >> $@
	@LANG=C echo >> $@
	@LANG=C echo \#define XEN_BANNER \\ >> $@
	cd ./figlet && make && ./figlet Xen $(XEN_VERSION).$(XEN_SUBVERSION)$(XEN_EXTRAVERSION) 1>>../$@ && cd ..
	@LANG=C echo >> $@

include/asm-$(TARGET_ARCH)/asm-offsets.h: arch/$(TARGET_ARCH)/asm-offsets.s
	@(set -e; \
	  echo "/*"; \
	  echo " * DO NOT MODIFY."; \
	  echo " *"; \
	  echo " * This file was auto-generated from $<"; \
	  echo " *"; \
	  echo " */"; \
	  echo ""; \
	  echo "#ifndef __ASM_OFFSETS_H__"; \
	  echo "#define __ASM_OFFSETS_H__"; \
	  echo ""; \
	  sed -ne "/^->/{s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; s:->::; p;}"; \
	  echo ""; \
	  echo "#endif") <$< >$@

.PHONY: default debug install dist clean delete-unfresh-files TAGS

SUBDIRS = arch common drivers 
TAGS: 
	( find include/asm-$(TARGET_ARCH) -name '*.h'; \
	  find include -type d \( -name "asm-*" -o -name config \) -prune -o \
		-name '*.h' -print; \
	  find $(SUBDIRS) -name '*.[ch]' ) | grep -v /SCCS/ | etags -
MAP:
	nm $(TARGET) | grep -v '\(compiled\)\|\(\.o$$\)\|\( [aUw] \)\|\(\.\.ng$$\)\|\(LASH[RL]DI\)' | sort > System.map
