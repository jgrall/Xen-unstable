#!/bin/sh

. /etc/rc.d/init.d/functions

qemubin=/usr/bin/qemu-dm

ulimit -c unlimited

# Use this for debugging:
#gdb --args /usr/sbin/qemu-dm -hda /var/images/qemu-linux.img -nographic \
#	-serial pty -l 'ioport,int' $*

# XXX this is a bit skanky. we assume an order of arguments here.
# namely to have configfile and vncconnect argument as the first 
# two arguments.

while getopts ":f:v:d:" opt;
do
    case $opt in
      f) QEMUCONFIGFILE=$OPTARG;;
      v) VNCCONNECT=$OPTARG;;
      d) DOMAIN=$OPTARG;;
      \?) echo;;
    esac
done
if [ "x$QEMUCONFIGFILE" != "x" ]; then shift; shift; fi
if [ "x$VNCCONNECT" != "x" ]; then shift; shift; fi


echo $QEMUCONFIGFILE
if [ ! -z $QEMUCONFIGFILE ];then
    . $QEMUCONFIGFILE
else
    echo "no config file specified!" > /dev/tty
    echo "no config file specified!" >> /tmp/qemustart.log
    exit
fi
 
PARMETER=""

if [ ! -z $hda ];then
PARMETER="$PARMETER -hda $hda"
fi

if [ ! -z $hdb ];then
PARMETER="$PARMETER -hdb $hdb"
fi

if [ ! -z $hdc ];then
PARMETER="$PARMETER -hdc $hdc"
fi

if [ ! -z $hdd ];then
PARMETER="$PARMETER -hdd $hdd"
fi

if [ ! -z $cdrom ];then
PARMETER="$PARMETER -cdrom $cdrom"
fi

if [ ! -z $boot ];then
PARMETER="$PARMETER -boot $boot"
fi

if [ ! -z $nographic ] && [ $nographic -eq 1 ];then
PARMETER="$PARMETER -nographic"
fi

vnc=${vnc:=1}
sdl=${sdl:=0}
if qemu-dm 2>&1 |grep vnc > /dev/null;then
	if [ $vnc -eq 1 ] && [ $sdl -eq 1 ];then
		PARMETER="$PARMETER -vnc-and-sdl -k en-us"
	elif [ $vnc -eq 1 ];then
		PARMETER="$PARMETER -vnc -k en-us"
	fi
    VNCPORT=`expr 5900 + $DOMAIN`
    PARMETER="$PARMETER -vncport $VNCPORT"
    if [ "x$VNCCONNECT" != "x" ]; then
        PARMETER="$PARMETER -vncconnect $VNCCONNECT"
    fi
fi

#optional cmdline for qemu        
#       -nographic \
#       -serial pty \


PARMETER="$PARMETER -l int $*";
echo "$qemubin $PARMETER" >>/tmp/qemustart.log
$qemubin $PARMETER &
