Index: ioemu/Makefile.target
===================================================================
--- ioemu.orig/Makefile.target	2006-12-08 01:41:12.000000000 +0000
+++ ioemu/Makefile.target	2006-12-08 01:41:12.000000000 +0000
@@ -355,7 +355,7 @@
 ifeq ($(TARGET_BASE_ARCH), i386)
 # Hardware support
 VL_OBJS+= ide.o pckbd.o ps2.o vga.o $(SOUND_HW) dma.o $(AUDIODRV)
-VL_OBJS+= fdc.o mc146818rtc.o serial.o i8254.o pcspk.o pc.o
+VL_OBJS+= fdc.o mc146818rtc.o serial.o pc.o
 VL_OBJS+= cirrus_vga.o mixeng.o parallel.o acpi.o piix_pci.o
 VL_OBJS+= usb-uhci.o
 DEFINES += -DHAS_AUDIO
Index: ioemu/hw/pc.c
===================================================================
--- ioemu.orig/hw/pc.c	2006-12-08 01:41:12.000000000 +0000
+++ ioemu/hw/pc.c	2006-12-08 01:41:12.000000000 +0000
@@ -38,7 +38,9 @@
 
 static fdctrl_t *floppy_controller;
 static RTCState *rtc_state;
+#ifndef CONFIG_DM
 static PITState *pit;
+#endif /* !CONFIG_DM */
 #ifndef CONFIG_DM
 static IOAPICState *ioapic;
 #endif /* !CONFIG_DM */
@@ -810,8 +812,10 @@
     }
 #endif /* !CONFIG_DM */
     isa_pic = pic_init(pic_irq_request, first_cpu);
+#ifndef CONFIG_DM
     pit = pit_init(0x40, 0);
     pcspk_init(pit);
+#endif /* !CONFIG_DM */
 #ifndef CONFIG_DM
     if (pci_enabled) {
         pic_set_alt_irq_func(isa_pic, ioapic_set_irq, ioapic);
Index: ioemu/vl.c
===================================================================
--- ioemu.orig/vl.c	2006-12-08 01:41:12.000000000 +0000
+++ ioemu/vl.c	2006-12-08 01:41:12.000000000 +0000
@@ -5570,6 +5570,7 @@
 
 #ifdef HAS_AUDIO
 struct soundhw soundhw[] = {
+#ifndef CONFIG_DM
 #ifdef TARGET_I386
     {
         "pcspk",
@@ -5579,6 +5580,7 @@
         { .init_isa = pcspk_audio_init }
     },
 #endif
+#endif /* !CONFIG_DM */
     {
         "sb16",
         "Creative Sound Blaster 16",
