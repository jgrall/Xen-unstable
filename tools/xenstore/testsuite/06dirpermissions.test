# Root directory: owned by tool, everyone has read access.
expect 0 READ
getperm /

# Create directory: inherits from root.
mkdir /dir
expect 0 READ
getperm /dir
setid 1
expect 0 READ
getperm /dir
dir /dir
expect write failed: Permission denied
write /dir/test create contents2

# Remove everyone's read access to directoy.
setid 0
setperm /dir 0 NONE
setid 1
expect dir failed: Permission denied
dir /dir
expect read failed: Permission denied
read /dir/test create contents2
expect write failed: Permission denied
write /dir/test create contents2

# Grant everyone write access to directory.
setid 0
setperm /dir 0 WRITE
setid 1
expect getperm failed: Permission denied
getperm /dir
expect dir failed: Permission denied
dir /dir
write /dir/test create contents
setid 0
expect 1 WRITE
getperm /dir/test
setperm /dir/test 0 NONE
expect contents
read /dir/test

# Grant everyone both read and write access.
setperm /dir 0 READ/WRITE
setid 1
expect 0 READ/WRITE
getperm /dir
expect test
dir /dir
write /dir/test2 create contents
expect contents
read /dir/test2
setperm /dir/test2 1 NONE

# Change so that user 1 owns it, noone else can do anything.
setid 0
setperm /dir 1 NONE
expect 1 NONE
getperm /dir
expect test
expect test2
dir /dir
write /dir/test3 create contents

# User 2 can do nothing.  Can't even tell if file exists.
setid 2
expect setperm failed: Permission denied
setperm /dir 2 NONE
expect getperm failed: Permission denied
getperm /dir
expect dir failed: Permission denied
dir /dir
expect read failed: Permission denied
read /dir/test
expect read failed: Permission denied
read /dir/test2
expect read failed: Permission denied
read /dir/test3
expect read failed: Permission denied
read /dir/test4
expect write failed: Permission denied
write /dir/test none contents
expect write failed: Permission denied
write /dir/test create contents
expect write failed: Permission denied
write /dir/test excl contents
expect write failed: Permission denied
write /dir/test4 none contents
expect write failed: Permission denied
write /dir/test4 create contents
expect write failed: Permission denied
write /dir/test4 excl contents

# Tools can always access things.
setid 0
expect 1 NONE
getperm /dir
expect test
expect test2
expect test3
dir /dir
write /dir/test4 create contents

# Inherited by child.
mkdir /dir/subdir
expect 1 NONE
getperm /dir/subdir
write /dir/subfile excl contents
expect 1 NONE
getperm /dir/subfile

# But for domains, they own it.
setperm /dir/subdir 2 READ/WRITE
expect 2 READ/WRITE
getperm /dir/subdir
setid 3
write /dir/subdir/subfile excl contents
expect 3 READ/WRITE
getperm /dir/subdir/subfile

# Inheritence works through multiple directories, too.
write /dir/subdir/1/2/3/4 excl contents
expect 3 READ/WRITE
getperm /dir/subdir/1/2/3/4
mkdir /dir/subdir/a/b/c/d
expect 3 READ/WRITE
getperm /dir/subdir/a/b/c/d
